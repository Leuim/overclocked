{% extends "base.html" %} {% block title %} Cart {% endblock %} 
{% block content %}
<div class="container">
  <div class="row align-items-center">
    <div class="col-4">
      <ul class="breadcrumb mb-0">
        <li class="breadcrumb-item">
          <a class="text-decoration-none" href="{% url 'home' %}">Home</a>
        </li>
        <li class="breadcrumb-item">
          <a class="text-decoration-none" href="{% url 'cart-detail' %}"
            >Cart</a
          >
        </li>
      </ul>
    </div>

    <div class="col-4 text-center">
      <h1 class="fw-bold text-muted mb-0">Cart</h1>
    </div>
    <div class="col-4 text-end"></div>
  </div>
</div>
<hr style="color: rgb(2, 49, 110); border: 2px solid" />
<div class="container d-flex justify-content-center mt-4">
  <div class="card shadow-sm" style="width: 100%; max-width: 500px">
    <div class="card-body">
      <h4 class="card-title text-center mb-3">Your Cart</h4>

      {% if cart.cartitem_set.all %}
      <ul class="list-group mb-3">
  {% for item in cart.cartitem_set.all %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    <div>
      {{ item.product.name }}
      <div class="d-flex align-items-center mt-2">
        <button type="button" class="btn btn-sm btn-outline-secondary update-qty" data-id="{{ item.id }}" data-action="decrease">-</button>
        <input type="text" class="form-control form-control-sm mx-2 text-center qty-input" 
               style="width: 60px;" value="{{ item.quantity }}" readonly>
        <button type="button" class="btn btn-sm btn-outline-secondary update-qty" data-id="{{ item.id }}" data-action="increase">+</button>
      </div>
    </div>

    <div>
      <span class="item-price" id="item-price-{{ item.id }}">{{ item.price }}</span> BHD
      <form method="post" action="{% url 'remove-from-cart' item.id %}" class="d-inline ms-2">
        {% csrf_token %}
        <button type="submit" class="btn btn-sm btn-danger">
          <i class="fa-solid fa-trash"></i>
        </button>
      </form>
    </div>
  </li>
  {% endfor %}
</ul>

<p class="text-end"><strong>Total: </strong><span id="cart-total">{{ cart.total_price }}</span> BHD</p>

      <button
        class="btn btn-success w-100"
        data-bs-toggle="modal"
        data-bs-target="#checkoutModal"
      >
        Checkout
      </button>
      <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <form method="post" action="{% url 'checkout' %}">
              {% csrf_token %}
              <div class="modal-header">
                <h5 class="modal-title">Checkout</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                ></button>
              </div>

              <div class="modal-body">
                <label class="form-label">Address</label>
                <input
                  type="text"
                  name="address"
                  class="form-control"
                  required
                />
                <input type="hidden" name="payment_method" value="cash" />
                <label class="form-label">Payment Method</label>
                <select name="payment_method" class="form-select" required>
                  <option value="cash">Cash</option>
                </select>
              </div>

              <div class="modal-footer">
                <button type="submit" class="btn btn-success">
                  Confirm Order
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      {% else %}
      <p class="text-center">Your cart is empty.</p>
      {% endif %}
    </div>
  </div>
</div>
<script>
document.querySelectorAll(".update-qty").forEach(button => {
  button.addEventListener("click", () => {
    const itemId = button.dataset.id;
    const action = button.dataset.action;
    const qtyInput = button.closest("li").querySelector(".qty-input");
    let currentQty = parseInt(qtyInput.value);

    if (action === "increase") {
      currentQty += 1;
    } else if (action === "decrease" && currentQty > 1) {
      currentQty -= 1;
    }

    qtyInput.value = currentQty;

    // Send AJAX request to backend
    fetch(`/cart/update/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ quantity: currentQty })
    })
    .then(res => res.json())
    .then(data => {
      // Update price and total dynamically
      document.querySelector(`#item-price-${itemId}`).textContent = data.item_price;
      document.querySelector("#cart-total").textContent = data.cart_total;
    });
  });
});
</script>

{% endblock %}
